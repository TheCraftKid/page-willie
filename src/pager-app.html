<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-styles/typography.html">
<link rel="import" href="../bower_components/paper-styles/color.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-messaging.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">

<dom-module id="pager-app">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        --app-primary-color: var(--paper-blue-500);
        --app-secondary-color: var(--paper-green-a200);
        display: block;
      }

      app-toolbar {
        color: #ffffff;
        background-color: var(--app-primary-color);
      }

      paper-button.main-button {
        background: var(--app-secondary-color);
      }

      paper-toast {
        width: 100%;
        max-width: 1280px;
      }

      section {
        padding: 16px;
      }

      main {
        @apply --layout-horizontal;
        @apply --layout-center-justified;
        min-height: 87vh;
      }

      footer {
        padding: 24px;
        width: 100vw;
        background: var(--paper-grey-500);
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-gap: 16px;
        grid-auto-rows: minmax(24px, auto);
      }

      footer>a {
        color: black;
        text-decoration: none;
      }

      section.container {
        max-width: 368px;
      }

      .request-container {
        padding: 16px;
      }

      .main-text {
        margin-top: 16px;
        text-align: center;
        @apply --paper-font-subhead;
      }

      .footer-item-end {
        text-align: end;
      }

      .container-page-button {
        @apply --layout-vertical;
      }

      /* mobile-small */

      @media all and (min-width: 0) and (max-width: 360px) and (orientation: portrait) {}

      /* mobile-large */

      @media all and (min-width: 361px) and (orientation: portrait) {}

      /* mobile-small-landscape */

      @media all and (min-width: 0) and (max-width: 480px) and (orientation: landscape) {}

      /* mobile-large-landscape */

      @media all and (min-width: 481px) and (orientation: landscape) {}

      /* tablet-small-landscape */

      @media all and (min-width: 600px) and (max-width: 960px) and (orientation: landscape) {}

      /* tablet-large-landscape */

      @media all and (min-width: 961px) and (orientation: landscape) {}

      /* tablet-small */

      @media all and (min-width: 600px) and (orientation: portrait) {}

      /* tablet-large */

      @media all and (min-width: 601px) and (max-width: 840px) and (orientation: portrait) {}

      /* desktop-x-small-landscape */

      @media all and (min-width: 0) and (max-width: 480px) and (orientation: landscape) {}

      /* desktop-x-small */

      @media all and (min-width: 0) and (max-width: 480px) and (max-aspect-ratio: 4/3) {}

      /* desktop-small-landscape */

      @media all and (min-width: 481px) and (max-width: 840px) and (orientation: landscape) {}

      /* desktop-small */

      @media all and (min-width: 481px) and (max-width: 840px) and (max-aspect-ratio: 4/3) {}

      /* desktop-medium-landscape */

      @media all and (min-width: 841px) and (max-width: 1280px) and (orientation: landscape) {}

      /* desktop-medium */

      @media all and (min-width: 841px) and (max-width: 1280px) and (max-aspect-ratio: 4/3) {}

      /* desktop-large */

      @media all and (min-width: 1281px) and (max-width: 1600px) {}

      /* desktop-xlarge */

      @media all and (min-width: 1601px) and (max-width: 1920px) {}
    </style>

    <firebase-app auth-domain="help-pager.firebaseapp.com" database-url="https://help-pager.firebaseio.com" api-key="AIzaSyCzt5XZJqWCSOszJeHkem6LN4MuyXylI7w"
      storage-bucket="help-pager.appspot.com" messaging-sender-id="745636416194">
    </firebase-app>

    <firebase-auth id="auth" user="{{user}}" provider="google" on-error="handleAuthError">
    </firebase-auth>

    <firebase-document path="/requests/[[requestId]]" data="{{currentRequest}}"></firebase-document>
    <firebase-query app-name="page-helper" path="/requests" data="{{allRequests}}"></firebase-query>

    <paper-dialog id="pageWillieDialog">
      <h2>Page a Willie</h2>
      <paper-dialog-scrollable>
        <div class="request-container">
          <paper-input label="Name"></paper-input>
          <paper-dropdown-menu class="options" label="Reason">
            <paper-listbox selected-item="{{currentRequest.reason}}" slot="dropdown-content">
              <paper-item>AP Computer Science help</paper-item>
              <paper-item>AP Calculus/Pre-AP Precalculus help</paper-item>
              <paper-item>Other help</paper-item>
            </paper-listbox>
          </paper-dropdown-menu>
          <paper-input label="Email (in case I can't respond in time)">
            <iron-icon icon="mail" slot="prefix"></iron-icon>
          </paper-input>
        </div>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss on-tap="cancelRequest">Cancel</paper-button>
        <paper-button dialog-confirm autofocus on-tap="pageWillie">Request</paper-button>
      </div>
    </paper-dialog>

    <app-toolbar>
      <div main-title>Page a Willie</div>
      <paper-icon-button icon="icons:account-circle" on-tap="signIn"></paper-icon-button>
    </app-toolbar>

    <main>
      <section id="introduction" class="container">
        <h2>What is "Page Willie"?</h2>
        <p>Page Willie is a service that allows you to request help from Willie Chalmers III, your tech help lord and savior.</p>
        </aside>

        <section id="pageButtonContainer" class="container container-page-button">
          <paper-button id="mainButton" class="main-button" raised on-click="pageWillie">Page Willie</paper-button>
          <span class="main-text">[[getAvailabilityText()]]</span>
        </section>

        <section id="latestRequests" class="container">
          <dom-repeat items="[[allRequests]]" as="request">

          </dom-repeat>
        </section>

        <paper-toast id="errorMessage" text="Sorry, I couldn't do that. Try again later."></paper-toast>
        <paper-toast id="offlineMessage" text="Page Willie requires an internet connection. Please check your network connection and try again."></paper-toast>
        <paper-toast id="requestMessage" text="Now paging Willie Chalmers III...">
          <paper-button id="undoPageWillie" onclick="undoPageWillie">UNDO</paper-button>
        </paper-toast>
    </main>

    <footer>
      <a href="https://sites.google.com/view/willie-projects/page-willie">About</a>
      <a class="footer-item-end" href="https://sites.google.com/view/willie-projects/">Projects like this</a>
    </footer>
  </template>

  <script>
    /**
     * The primary app for the 
     * @customElement
     * @polymer
     */
    class PagerApp extends Polymer.Element {
      static get is() { return 'pager-app'; }
      static get properties() {
        return {
          user: Object,
          requestId: {

          },
          available: {
            type: Boolean,
            value: false,
          },
          currentRequest: Object,
          allRequests: {
            type: Object,
            observer: 'requestsChanged',
          },
        };
      }

      requestsChanged(newData, oldData) {
        console.log('Old data:', oldData);
        console.log('New data:', newData);
      }

      updateAvailability(available) {
        this.available = available;
      }

      getAvailabilityText() {
        return `Willie is ${this.available ? 'available' : 'unavailable'} 
        right now, ${this.available ? '' : 'you can still page him.'}`;
      }

      signIn() {
        this.$.auth.signInWithPopup()
          .then((response) => {
            console.info('Sign in successful', response);
          })
          .then(handleAuthError);
      }

      pageWillie() {
        this.$.pageWillieDialog.open();
      }

      handleAuthError(e) {
        console.error('Error when signing in', e);
        // TODO: Show auth-related toast
        this.$.errorMessage.show();
      }

      generatePageRequest(name, reason, email) {
        this.currentRequest = new Object();
        return {
          name: name,
          reason: reason,
          email: email,
        };
      }

      enableButton(option) {
        // TOOD: Use with query selector to allow multiple paging buttons
        this.$.mainButton.disabled = !option;
      }
    }

    window.customElements.define(PagerApp.is, PagerApp);
  </script>
</dom-module>